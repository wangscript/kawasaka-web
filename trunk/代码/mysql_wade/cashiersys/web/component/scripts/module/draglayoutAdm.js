(function(){if(typeof(System)=="undefined"){alert('缺少支持的代码');return;}if(typeof(System.Data)=="undefined"){Include('support/data.js');}var dh=System.DomHelper;var ajax=Wade.ajax;var updateMode=true;var columnListContainerID="columnList";var partDesignContainerID='partDesignContainerTable';var columnListTplStr='<tr><td index="{index}"><input class="e_input" type="0" maxlength="10" type="text" onblur="javascript:DraglayoutAdm.updateTextboxValue(0,this);"  value="{name}"  /></td><td index="{index}">{width:getColumnWidthTextBox("width")}</td><td>{orderno}</td></tr>';var dragItemIDPrefix='item';var dragItemTplStr='<div id="' +dragItemIDPrefix+ '{itemindex}" index="{itemindex}" name="drag_item" class="l_mt">'+      '<div class="c_box">' +       '<span name="itemtitle">{itemtitle}</span>' +       '<div class="c_line l_mt"></div>' +       '<div class="l_mt" style="text-align:right;">' +        '<a href="javascript:void(0);" class="{editstyle}" onfocus="this.blur()" onclick="javascript:{editaction}"><span>编辑</span></a>' +        '<a href="javascript:void(0);" class="e_bLinkDeleteNB" onfocus="this.blur()" onclick="javascript:DraglayoutAdm.removeItemData(this);"><span>移除</span></a>' +       '</div>'+      '</div>'+     '</div>';var titleStrReg=/^[a-zA-Z0-9_,。\n\u0391-\uFFE5]+$/;    window['DraglayoutAdm']=(function(){ return {  columns:new System.MixedCollection(),        items:new System.MixedCollection(),        itemsCache:new System.MixedCollection(),        nextcolumn:0,        pagetypeid:null,        pageid:null,        createXmlDocument:function (xmlstr){            var xmlDocument;            if(System.UserAgent.ie){                xmlDocument = new ActiveXObject("Msxml2.FreeThreadedDOMDocument");                xmlDocument.async=false;xmlDocument.resolveExternals = false;                xmlDocument.loadXML(xmlstr);            }else{               xmlDocument = (new DOMParser()).parseFromString(xmlstr, "text/xml");            }                   return xmlDocument;            }    };})();DraglayoutAdm.dragDrop={};DraglayoutAdm.dragDrop.Util=(function(){    var dlAdm=DraglayoutAdm;    var dd=DraglayoutAdm.dragDrop;        return {     isGecko:System.UserAgent.gecko,     isOpera:System.UserAgent.opera,     getOffset:function(el, isLeft) {          var  retvalue  = 0;          while  (el  !=   null ) {             retvalue  +=  el['offset' + (isLeft?'Left':'Top')];             el  =  el.offsetParent;         }         return  retvalue;     },     bindFunction:function(el, fucName) {          return   function  () {              return  el[fucName].apply(el, arguments);         };     },     re_calcOff:function (el) {            var me=this;            if(typeof(dlAdm.items)!='undefined'){                dlAdm.items.each(function(item){if(item.elm){                    item.elm.pagePosLeft=me.getOffset(item.elm,true);                    item.elm.pagePosTop=me.getOffset(item.elm,false);                }});                var nextSib=el.elm.nextSibling;                while(nextSib){                    nextSib.pagePosTop-=el.elm.offsetHeight;                    nextSib=nextSib.nextSibling;                }            }     },     hide :function  () {      var re=document.getElementById(partDesignContainerID);         if(re)re.style.display='none' ;     },     show :function  () {         var re=document.getElementById(partDesignContainerID);         if(re)re.style.display='' ;     }    };})();DraglayoutAdm.dragDrop.DragHandler=(function(){ var dd=DraglayoutAdm.dragDrop;  return {     obj: null,      init: function (element) {         element.onmousedown  =  this.start;   element.obj=element;         if(isNaN(parseInt(element.style.left))) {            element.style.left  =   '0px';         }         if(isNaN(parseInt(element.style.top))) {             element.style.top  =   '0px' ;         }         element.onDragStart  =   new  Function();         element.onDragEnd  =   new  Function();         element.onDrag  =   new  Function();     },     start: function  (event) {         var  element = dd.DragHandler.obj=this.obj;         event = dd.DragHandler.fixE(event);         if (event.which!=1 ) {return true ;}         var erc=event.srcElement || event.target;         if(erc && erc.tagName && erc.tagName.toLowerCase()!='div') return false;                  element.onDragStart();         element.lastMouseX  =  event.clientX;         element.lastMouseY  =  event.clientY;         document.onmouseup  =  dd.DragHandler.end;         document.onmousemove  = dd.DragHandler.drag;         return   false;     },      drag: function  (event) {          event= dd.DragHandler.fixE(event);          if  (event.which  ==   0 ) {              return dd.DragHandler.end();          }          var  element  =  dd.DragHandler.obj;          var  _clientX  =  event.clientY;          var  _clientY  =  event.clientX;           if(element.lastMouseX== _clientY && element.lastMouseY==_clientX) {              return false ;          }          var  _lastX=parseInt(element.style.top);          var  _lastY=parseInt(element.style.left);            var  newX, newY;         newX  =  _lastY  +  _clientY  -  element.lastMouseX;         newY  =  _lastX  +  _clientX  -  element.lastMouseY;           element.style.left  =  newX  +   'px' ;         element.style.top  =  newY  +   'px' ;          element.lastMouseX  =  _clientY;         element.lastMouseY  =  _clientX;          element.onDrag(newX, newY);         return false ;     },     end: function  (event) {            event  =  dd.DragHandler.fixE(event);                   document.onmousemove  =   null ;         document.onmouseup  =   null ;                 var  _onDragEndFuc  =  dd.DragHandler.obj.onDragEnd();                dd.DragHandler.obj  =   null ;         return  _onDragEndFuc;     },      fixE: function  (ig_) {         if  (typeof(ig_)== "undefined") {             ig_ =window.event;         }          if  (typeof(ig_.layerX)=="undefined") {             ig_.layerX=ig_.offsetX;         }          if  (typeof(ig_.layerY)== "undefined") {             ig_.layerY=ig_.offsetY;         }          if  (typeof(ig_.which)== "undefined") {             ig_.which=ig_.button;         }         return  ig_;     } };})();DraglayoutAdm.dragDrop.DragEvent=(function(){ var dlAdm=DraglayoutAdm; var dd=DraglayoutAdm.dragDrop; return {  start_Drag:function() {      dd.Util.re_calcOff(this);      this.origNextSibling  = this.elm.nextSibling;      var  _ghostElement  =  dd.DragHelper.getGhostElement();      var  offH  =  this.elm.offsetHeight;      if (dd.Util.isGecko) {          offH  -=  parseInt(_ghostElement.style.borderTopWidth)*2 ;      }      var  offW  =   this.elm.offsetWidth;      var  offLeft = dd.Util.getOffset(this.elm, true );      var  offTop  =  dd.Util.getOffset(this.elm, false );      dd.Util.hide();            this.elm.style.width  =  offW  +  'px' ;      _ghostElement.style.height  =  offH  + 'px' ;      this.elm.parentNode.insertBefore(_ghostElement,this.elm.nextSibling);      this.elm.style.position = 'absolute';      this.elm.style.zIndex = 100;      this.elm.style.left =  offLeft+ 'px';      this.elm.style.top  =  offTop + 'px';      dd.Util.show();            this .isDragging =false ;      return  false;  },  when_Drag:function(clientX, clientY) {      if(!this.isDragging) {           this.elm.style.filter= 'alpha(opacity=70)';           this.elm.style.opacity=0.7 ;           this.isDragging=true ;      }        var  found =null;       var distance, max_distance  =   100000000 ;       var me=this;              dlAdm.items.each(function(item){                if(!item || !item.elm){ return;}                if(me.elm==item.elm){return;}                distance = Math.sqrt(Math.pow(clientX-item.elm.pagePosLeft,2) + Math.pow(clientY- item.elm.pagePosTop,2));                 if (typeof(distance)=='undefined' || distance==null || isNaN(distance)){ return;}                if (distance<max_distance){                    max_distance  = distance;                    found  =  item;                }distance=null;            });      var _ghostElement  =  dd.DragHelper.getGhostElement();      if (found  !=null && _ghostElement.nextSibling  !=  found.elm) {          found.elm.parentNode.insertBefore(_ghostElement, found.elm);           if(dd.Util.isOpera) {              document.body.style.display  =  'none';              document.body.style.display  =   '';          }      }  },  end_Drag:function() {      if( this._afterDrag()) {                 }      return   true;  },  after_Drag:function() {       var  returnvalue  =   false ;       dd.Util.hide();       this.elm.style.position  = '';       this.elm.style.width  =  '';       this.elm.style.zIndex  =   '';       this.elm.style.filter  =   '';       this.elm.style.opacity  =   '';          var  ele = dd.DragHelper.getGhostElement();      if(ele.nextSibling  !=   this .origNextSibling) {           ele.parentNode.insertBefore( this .elm, ele.nextSibling);          returnvalue  =   true ;      }      ele.parentNode.removeChild(ele);      dd.Util.show();      if(dd.Util.isOpera) {          document.body.style.display  ='none';          document.body.style.display  ='';      }      return  returnvalue;  } };})();DraglayoutAdm.dragDrop.DragHelper=(function(){ var dlAdm=DraglayoutAdm; var dd=DraglayoutAdm.dragDrop; var ghostElement=null ; return {  getGhostElement:function () {      if (!ghostElement) {          ghostElement  =  document.createElement('div');          ghostElement.className='l_mt';          ghostElement.backgroundColor  ='';          ghostElement.style.border ='2px dashed #aaa';          ghostElement.innerHTML='';      }      return  ghostElement;  } }; })();DraglayoutAdm.column=function(_id,_width,_name,_orderno){ this.index=_id; this.width=_width; this.name=_name; this.orderno=_orderno;};DraglayoutAdm.item=function(_id,_columnid,_name,_orderno){ this.index=_id; this.name=_name; this.columnid=_columnid; this.orderno=_orderno;};DraglayoutAdm.item.prototype=(function(){  var dd=DraglayoutAdm.dragDrop; return {  dragable:function() {       this._dragStart=dd.DragEvent.start_Drag;       this._drag=dd.DragEvent.when_Drag;       this._dragEnd=dd.DragEvent.end_Drag;       this._afterDrag=dd.DragEvent.after_Drag;       this.isDragging= false;        if(this.elm){           this.elm.style.cursor='move';           dd.DragHandler.init(this.elm);           this.elm.onDragStart=dd.Util.bindFunction(this,'_dragStart');           this.elm.onDrag =dd.Util.bindFunction(this,'_drag');           this.elm.onDragEnd =dd.Util.bindFunction(this,'_dragEnd');      }  } };})();(function(){ var dlAdm=DraglayoutAdm; dh.Template.Format.getColumnWidthTextBox=function(w){     if(w=="auto"){return '<div class="text" style="text-align:left;">自适应</div>';}  return '<input type="1" class="e_input" maxlength="3" onblur="javascript:DraglayoutAdm.updateTextboxValue(1,this);" style="width:120px;" type="text" value="' + w + '" />'; }; function convertToGBK(num){  var r="";  if(typeof(num)=='number' && num>-1 && num<5){   var  AA=new Array("一","二","三","四","五");   r=AA[num];AA=[];AA=null;  }  return r; };  System.apply(DraglayoutAdm,{  showLoadingMask:function(str){   var lm=System.get('loadingMask');   if(lm){    lm.setStyle('display','block');    if(str && str!=''){     loadFont=lm.child('.loading');     if(loadFont){      loadFont.update(str);     }loadFont=null;    }   }lm=null;  },  hideLoadingMask:function(){   var lm=System.get('loadingMask');   if(lm){lm.setStyle('display','none');}lm=null;  },  init:function(){   var me=this;   var pTypeID=System.get('PAGETYPE_ID');   if(pTypeID && pTypeID.dom.value && /^\d+$/.test(pTypeID.dom.value)){    dlAdm.pagetypeid=pTypeID.dom.value;   }pTypeID=null;   var pID=System.get('PAGE_ID');   if(pID && pID.dom.value && /^\d+$/.test(pID.dom.value)){    dlAdm.pageid=pID.dom.value;    this.loadPageData(dlAdm.pageid);   }else{    dlAdm.createColumnData(3);    me.checkedColumnLayout();   }pID=null;   var upMode=document.getElementById("UPDATEMODE");   if(upMode && upMode.nodeType){    upMode=upMode.value;    if(typeof(upMode)=="string" && /^-?\d+$/.test(upMode)){     updateMode=!(parseInt(upMode)<0);    }   }   me.disableSaveButton();  },  loadPageData:function(pageid){   var me=this;   ajax.ajaxDirect(null,"getPageXmlData",'Page_ID=' + pageid + '&randomt=' + Math.random(),'',false,function(r){    var xmlDoc=dlAdm.createXmlDocument(r.responseText);                var reader = new System.Data.XmlReader({record:'column',id:'@id'},['@name','@width','@orderno']);                var itemReader=new System.Data.XmlReader({record:'item',id:'@id'},['@columnid','@itemtitle','@orderno']);                                var root=xmlDoc.documentElement || xmlDoc;                var d=document.getElementById('page_Desc');                if(d)d.value=dh.DomQuery.selectValue('page/pagedesc',root);    d=dh.DomQuery.selectValue('page/@typeid',root);if(/^\d+$/.test(d)){dlAdm.pagetypeid=d;}d=null;                                var itemData,itemDI,columnID;                var data=reader.readRecords(xmlDoc);                if(data && data.records.length){                 var dataItem,title;                 for(var i=0;i<data.records.length;i++){                  dataItem=data.records[i];                  columnID=dataItem.id;                  dlAdm.columns.add(columnID,new dlAdm.column(columnID,dataItem.get('@width'),dataItem.get('@name'),dataItem.get('@orderno')));                    itemData=itemReader.readRecords(dataItem.node);                  if(itemData && itemData.records.length){                   for(var j=0;j<itemData.records.length;j++){        itemDI=itemData.records[j];                    dlAdm.items.add(itemDI.id,new dlAdm.item(itemDI.id,                        columnID,itemDI.get('@itemtitle'),                        itemDI.get('@orderno')));                   }                  }                 }                me.createColumnList();                me.disabledColumnLayoutSelect();                me.enablePartAddButton();                me.displayPartDesign();                me.createColumnLayout();                me.checkedColumnLayout();                me.enableSaveButton();                (function(){                 var cb,html,tpl=new dh.Template(dragItemTplStr);                 var tc;                 dlAdm.columns.each(function(c){                  if(c && (cb=System.get('c_layout_b_' + c.orderno))){                   tc=new System.MixedCollection();                   dlAdm.items.each(function(item){                    if(item.columnid==c.index){                     tc.add(item.orderno,{index:item.index,title:item.name});           }                   });                   tc.keySort('DESC');          tc.each(function(item){           html=tpl.apply({itemindex:item.index,itemtitle:item.title,editstyle:(updateMode?"e_bLinkEditNB":"e_bLinkEditNBDis"),editaction:(updateMode?"DraglayoutAdm.editItemData(this);":"return false;")});                    item=dlAdm.items.get(item.index);                    if(item){                     item.elm=cb.insertHtml('afterbegin',html);;            item.dragable();           }       });       tc=null;                  }                 });cb=null;tpl=null;html=null;                })();                 }data=null;                reader=null;xmlDoc=null;tpl=null;    Wade.page.endPageLoading();                   });  },  createColumnData:function(num){   if(typeof(num)=='number' && dlAdm.columns.length!==num){      dlAdm.columns.clear();      for(var i=0;i<num;i++){        dlAdm.columns.add(i,new dlAdm.column(i,(i==1)?'auto':200,('第' + convertToGBK(i) + '列'),i));      }      this.createColumnList();   }  },  createColumnList:function(){   var tpl=new dh.Template(columnListTplStr);   this.clearColumnList();      dlAdm.columns.each(function(item){       tpl.append(columnListContainerID,{index:item.index,width:item.width,name:item.name,orderno:item.orderno});      });      tpl=null;  },  clearColumnList:function(){       var trs=System.query('#' + columnListContainerID + ' tr');       if(trs && trs.length){        for(var i=0;i<trs.length;i++){         System.fly(trs[i]).remove();        }       }trs=null;  },  createColumnLayout:function(){   this.clearColumnLayout();   var tb=System.query('#' + partDesignContainerID +' tbody');   if(tb && tb.length){    tb=System.fly(tb[0]);    var headerStrAry=new Array(),columnStrAry=new Array();    headerStrAry.push('<tr>');columnStrAry.push('<tr>');    var width;    dlAdm.columns.each(function(item){     width=(item.width!=='auto')?item.width + 'px':item.width;     headerStrAry.push('<td id="c_layout_h_' + item.orderno + '"><div class="text" style="text-align:center;padding:3px;font-weight:bold;">' + item.name + '</div></td>');        columnStrAry.push('<td id="c_layout_b_' + item.orderno + '" class="l_colLi" style="width:' + width + ';height:300px;border:solid 1px #b2ccdf;padding-left:4px;padding-right:4px;padding-bottom:8px;"><div name="dragbottomitem">&nbsp;</div></td>');    });width=null;    headerStrAry.push('</tr>');columnStrAry.push('</tr>');    tb.insertHtml('beforeend',headerStrAry.join(''));    tb.insertHtml('beforeend',columnStrAry.join(''));    headerStrAry=[];headerStrAry=null;    columnStrAry=[];columnStrAry=null;   }tb=null;    this.createColumnBottomitem();    },  createColumnBottomitem:function(){   var items=System.query('#' + partDesignContainerID + ' div[name=dragbottomitem]');   if(items && items.length){    for(var i=0;i<items.length;i++){     var t=new dlAdm.item('dragbottomitem' + i);     t.elm=items[i];     dlAdm.items.add(t);         }   }items=null;  },  clearColumnLayout:function(){   var trs=System.query('#' + partDesignContainerID +' tr');   if(trs && trs.length){        for(var i=0;i<trs.length;i++){         System.fly(trs[i]).remove();        }       }trs=null;  },  checkedColumnLayout:function(){   var n=dlAdm.columns.length;   if(n && n>0){    var ckb=document.getElementById('ckb_cl' + n);    if(ckb)ckb.checked=true;ckb=null;   }  },  disabledColumnLayoutSelect:function(){   var ckbs=System.query('#' + dh.id(document.body)+ ' input[name=ckb_ColumnLayout]');   if(ckbs && ckbs.length){    for(var i=0;i<ckbs.length;i++){     ckbs[i].disabled=true;    }   }ckbs=null;   var btn=System.get('btn_ColumnLayoutSel');   if(btn){btn.replaceClass('e_bLinkOK','e_bLinkOKDis');btn.dom.onclick=null;}   btn=null;  },  completeColumnLayoutSelect:function(){   if(!confirm('完成选择后将不能再选择其它的列布局，确定要选择当前列布局吗？')) return;   this.disabledColumnLayoutSelect();   this.displayPartDesign();   this.createColumnLayout();   this.enablePartAddButton();   this.enableSaveButton();  },  displayPartDesign:function(){   var pd=System.get('fsPartDesign');   if(pd){pd.setStyle('display','block');}   pd=null;  },  hiddenPartDesign:function(){   var pd=System.get('fsPartDesign');   if(pd){pd.setStyle('display','none');}   pd=null;  },  enablePartAddButton:function(){   var btn=System.get('btn_addPart');   if(btn){    btn.replaceClass('e_bLinkAddDis','e_bLinkAdd');    btn.dom.onclick=function(){DraglayoutAdm.addPartDialog.show();DraglayoutAdm.addPartDialog.setChooseMode();};    btn.dom.onfocus=function(){this.blur();return false;};   }btn=null;  },  disablePartAddButton:function(){   var btn=System.get('btn_addPart');   if(btn){    btn.replaceClass('e_bLinkAdd','e_bLinkAddDis');    btn.dom.onclick=null;    btn.dom.onfocus=function(){this.blur();return false;};   }btn=null;  },  enableSaveButton:function(){   var btn=System.get('btn_Save');   if(btn){    btn.replaceClass('e_bLinkSaveDis','e_bLinkSave');    btn.dom.onclick=dlAdm.updatePageData;    btn.dom.onfocus=function(){this.blur();return false;};   }btn=null;  },  disableSaveButton:function(){   var btn=System.get('btn_Save');   if(btn){    btn.replaceClass('e_bLinkSave','e_bLinkSaveDis');    btn.dom.onclick=null;    btn.dom.onfocus=function(){this.blur();return false;};   }btn=null;    },  updateTextboxValue:function(type,tbObj){   document.onclick=null;   if(!/^\d+$/.test(type) || !tbObj) return;   var td=dh.findParentNode(tbObj,'td',2);   if(td){    var id=td.getAttribute('index');    if(/^\d+$/.test(id)){     if(type==0){DraglayoutAdm.updateColumnName(id,tbObj);}     else if(type==1){DraglayoutAdm.updateColumnWidth(id,tbObj);}    }   }td=null;  },  updateColumnName:function(id,tbObj){   if(tbObj && tbObj.nodeType){    var column=dlAdm.columns.get(id);    if(column){     if(tbObj.vlaue=='' || !titleStrReg.test(tbObj.value)){      alert('列名输入不合法！');      tbObj.value=column.name;      document.onclick=null;      return;     }else{      column.name=tbObj.value;         var div=System.query('#c_layout_h_' + column.orderno + ' div');      if(div && div.length){       div=div[0];       div.innerHTML=column.name;       return;      }      div=null;     }    }   }tbObj=null;  },  updateColumnWidth:function(id,tbObj){   if(tbObj){    var column=dlAdm.columns.get(id);    if(column){     if(!(/^\d+$/.test(tbObj.value))){      alert('宽度值只能是整数！');      tbObj.value=column.width;      return;     }else{      column.width=tbObj.value;      var clb=System.get('c_layout_b_' + column.orderno);      if(clb){clb.setWidth(column.width)}      clb=null;     }    }   }tbObj=null;    },  updateColumnInfo:function(){   var tds=System.query('#columnList td');   var id,tb,type;   if(tds && tds.length){    for(var i=0;i<tds.length;i++){     id=tds[i].getAttribute('index');     if(/^\d+$/.test(id)){      tb=System.fly(tds[i]).child('input');      if(tb && tb.dom){       type=tb.dom.getAttribute('type');       if(type==0){        dlAdm.updateColumnName(id,tb.dom);       }else if(type==1){        dlAdm.updateColumnWidth(id,tb.dom);       }      }     }    }   }  },  createItemData:function(id,title){   if(!(id && id!='') || !(title && title!='')) return;   var cb=dlAdm.columns.items[dlAdm.nextcolumn];   var cid=cb.index;   if(cb && (cb=System.get('c_layout_b_' + cb.orderno))){    var tpl=new dh.Template(dragItemTplStr);    var html=tpl.apply({itemindex:id,itemtitle:title,editstyle:(updateMode?"e_bLinkEditNB":"e_bLinkEditNBDis"),editaction:(updateMode?"DraglayoutAdm.editItemData(this);":"return false;")});    var t=new dlAdm.item(id,cid,title,0);    dlAdm.items.add(id,t);    t.elm=cb.insertHtml('afterbegin',html);    t.dragable();    html=null;tpl=null;   }cb=null;   dlAdm.nextcolumn++;   if(dlAdm.nextcolumn==dlAdm.columns.length){dlAdm.nextcolumn=0;}  },  editItemData:function(el){   if(el){    var div=dh.findParentNode(el,'div[name=drag_item]',5);    if(div){     var id=dh.DomQuery.selectValue('@index',div);     if(/^\d+$/.test(id)){      DraglayoutAdm.addPartDialog.bUpTitle=true;      DraglayoutAdm.addPartDialog.show();      DraglayoutAdm.addPartDialog.loadItemData(id);     }    }div=null;   }    },  removeItemData:function(el){   if(el){    if(confirm("确实要移除吗？")){     var div=dh.findParentNode(el,'div[name=drag_item]',5);     if(div){      var id=dh.DomQuery.selectValue('@index',div);      if(/^\d+$/.test(id)){       dlAdm.items.removeKey(id);       System.fly(div).remove();      }     }div=null;    }   }  },  updateItemsInfo:function(){   var item,items;   dlAdm.columns.each(function(c){    items=System.query('#c_layout_b_' + c.orderno + ' div[name=drag_item]');    if(items && items.length){     for(var i=0;i<items.length;i++){        item=items[i];        var reg=/^[a-zA-Z_]+(\d+)$/ig;        if(item && item.id && reg.test(item.id)){          var id=item.id.replace(reg,'$1','');          item=dlAdm.items.get(id);          if(item){item.orderno=i;item.columnid=c.index;}        }reg=null;     }    }items=null;   });  },  createXmlData:function(){   dlAdm.updateItemsInfo();   var str='<xml>';   str +='<page';   if(/^\d+$/.test(dlAdm.pagetypeid)){str+=' typeid=\"' + dlAdm.pagetypeid + '\"';}   if(/^\d+$/.test(dlAdm.pageid)){str+=' id=\"' + dlAdm.pageid + '\"';}   var d;if(d=document.getElementById('page_Desc')){str+=' desc=\"' + d.value+ '\"';}d=null;   if((d=document.getElementById("RELATIONTYPE")) && d.nodeType && d.value!="null"){str+=' relationtype=\"' + d.value+ '\"';}   str+='>';   dlAdm.columns.each(function(c){    str +='<column id="' + c.index + '" name="' + c.name + '" width="' + c.width + '" orderno="' + c.orderno + '" >';    dlAdm.items.each(function(item){     if(/^\d+$/.test(item.index) && item.columnid==c.index){         str+='<item id="' + item.index + '" orderno="' + item.orderno + '"></item>';     }    });    str+='</column>';   });   str+='</page>';   str+='</xml>';            return str;  },  updatePageData:function(){   if(!(/^\d+$/.test(dlAdm.pagetypeid))){alert("错误的页面类型!");return;}   var pd=document.getElementById("page_Desc");if(pd==null || pd.value==""){alert("请填写页面描述！");return;}pd=null;   var postbody=ajax.buildPostData({XMLDATA:dlAdm.createXmlData()});   ajax.ajaxPost(null,'updatePageData','randomt=' + Math.random(),'',false,postbody,true,function(r){    var xmlDoc=dlAdm.createXmlDocument(r.responseText);    var root=xmlDoc.documentElement || xmlDoc;                var rt=dh.DomQuery.selectValue('XMLDATA[id=xmldata]',root);                root=null;xmlDoc=null;    if(rt=="faild"){alert("更新数据失败！");return;}    var suc=false;        if(typeof(rt)!='undefined' && rt!=''){     try{suc=true;eval(rt);}catch(e){}     if(typeof(cids)!='undefined' && (cids instanceof Array)){      dlAdm.columns.each(function(c,index){       c.index=cids[index];      });      cids=[];cids=null;     }if(/^\d+$/.test(pid)){dlAdm.pageid=pid;}    }    rt=null;    if(suc){     Wade.page.endPageLoading();    }   });  } });})();DraglayoutAdm.addPartDialog=(function(){ var dlAdm=DraglayoutAdm; var objDialog=null; var objTabset=null;  function tabPageChanged(){  var tab=objTabset.getActiveTab();  if (tab.caption == "\u5217\u8868"){   DraglayoutAdm.addPartDialog.editItemID=null;   DraglayoutAdm.addPartDialog.clearInput();    objDialog.buttons[0].enable();}  if (tab.caption == "\u65B0\u589E\u002F\u7F16\u8F91"){    objDialog.buttons[0].disable();} } return {  bUpTitle:false,  itemListLoaded:false,  init:function(){   if(!objDialog){    objDialog=new System.UI.Components.BasicDialog("draglayout_addpart_dlg", {      shim:false,                  modal:true,                  shadow:false,                  resizable:false,                  collapsible:false,                  fixedcenter:true,                  constrain:false,                  constraintoviewport:false,                  width:650,                  height:400,                  draggable:false,                  proxyDrag:false          });           objDialog.addButton('\u9009\u53D6', this.btnOk_Click, this);          objDialog.addButton('\u5173\u95ED', objDialog.hide, objDialog);                }    if(!objTabset){    var page1=document.getElementById("draglayout_addpart_tabset_page1");    var page2=document.getElementById("draglayout_addpart_tabset_page2");    objTabset=new Wade.component.TabSet("draglayout_addpart_tabset","top");    objTabset.addTab("\u5217\u8868", page1);    if(!updateMode){page2.style.display="none";}    else{objTabset.addTab("\u65B0\u589E\u002F\u7F16\u8F91",page2);}    objTabset.draw();    objTabset.onTabSelect(tabPageChanged);    objTabset.setContentHeight(300);        page1=null;page2=null;   }       this.btnPartQuery=System.get('btn_partQuery');   if(this.btnPartQuery){    this.btnPartQuery.on("click",this.queryItemList,this);   }    this.btnAddPartCanel=System.get('btn_AddPartCanel');   if(this.btnAddPartCanel){    this.btnAddPartCanel.on("click",this.setChooseMode,this);   }     this.btnAddPartOk=System.get("btn_AddPartOk");   if(this.btnAddPartOk){    this.btnAddPartOk.on("click",this.updateItemData,this);   }   },  btnOk_Click:function(){   this.hide();   var dataItem,contain=false;   var cks=System.query('#itemListContainer input[type=checkbox]');   if(cks && cks.length){    for(var i=0;i<cks.length;i++){     if(cks[i].checked && !cks[i].disabled){      contain=dlAdm.items.containsKey(cks[i].value);      dataItem=dlAdm.itemsCache.get(cks[i].value);      if(dataItem && !contain){       dlAdm.createItemData(dataItem.id,dataItem.title);      }        }    }   }cks=null;   System.CG();  },  show:function(){   if(objDialog){objDialog.show();}   this.createItemList();  },  hide:function(){   if(objDialog){objDialog.hide();}   System.CG();  },  setChooseMode:function(){   this.clearInput();   objTabset.switchTo("\u5217\u8868");  },  setAddMode:function(){   this.clearInput();   objTabset.switchTo("\u65B0\u589E\u002F\u7F16\u8F91");   },  setEditMode:function(){   objTabset.switchTo("\u65B0\u589E\u002F\u7F16\u8F91");    },  clearInput:function(){   var oName=document.getElementById('tb_PartEdit_Name');   var oAddr=document.getElementById('tb_PartEdit_Addr');   var oDesc=document.getElementById('tb_PartEdit_Desc');   if(!oName || !oAddr || !oDesc) return false;   oName.value='';oAddr.value='';oDesc.value='';     },  createItemList:function(postBody,force){   var me=this;   if(me.itemListLoaded==true && !force){        me.setCheckedItems();    return;   }   var tpl=new dh.Template('<tr>'+         '<td><span><input name="chk_itemindex" type="checkbox" onfocus="this.blur();" value="{itemindex}" /></span></td>'+         '<td><span>{itemindex}</span></td>'+         '<td><span>{itemtitle}</span></td>'+         '<td><span>{itemdesc}</span></td>'+         '</tr>');   if(typeof(postBody)!="string")postBody="";   var oRelationType=document.getElementById("RELATIONTYPE");   if(oRelationType && oRelationType.nodeType){    postBody+="&RelationType=" + oRelationType.value;   }oRelationType=null;   ajax.AjaxLoading=false;         ajax.ajaxPost(null,'getPageItemCollectionData','randomt=' + Math.random(),'',false,postBody,true,function(r){    me.clearItemList();    var xmlDoc=dlAdm.createXmlDocument(r.responseText);                var reader = new System.Data.XmlReader({ record: 'item',id:'@id'},['itemtitle','itemdesc']);                var data=reader.readRecords(xmlDoc);                if(data && data.records.length){                 var dataItem,title;                 for(var i=0;i<data.records.length;i++){                  dataItem=data.records[i];                  title=dataItem.get('itemtitle');                  tpl.append('itemListContainer',{                    itemindex:dataItem.id,                    itemtitle:(updateMode?'<a href="javascript:void(0);" onclick="javascript:DraglayoutAdm.addPartDialog.loadItemData('+ dataItem.id +',false);">' + title + '</a>':title),                    itemdesc:dataItem.get('itemdesc')});                    dlAdm.itemsCache.add(dataItem.id,{id:dataItem.id,title:title});                   }                }data=null;                reader=null;xmlDoc=null;tpl=null;                me.setCheckedItems();                me.itemListLoaded=true;                ajax.AjaxLoading=true;                tpl=null;   });  },  clearItemList:function(){       var trs=System.query('#itemListContainer tr');       if(trs && trs.length){        for(var i=0;i<trs.length;i++){         System.fly(trs[i]).remove();        }       }trs=null; System.CG();    },  queryItemList:function(){   var oID=document.getElementById('q_PartID');   var oName=document.getElementById('q_PartName');   if(oID && oName){        if(oID.value!='' && !titleStrReg.test(oID.value)){alert('部件编号输入不合法!');return false;}    if(oName.value!='' && !titleStrReg.test(oName.value)){alert('部件名称输入不合法!');return false;}        var postData=ajax.buildPostData({Item_ID:oID.value,Item_Title:oName.value});    this.clearItemList();    if(oID=System.get('itemListContainer'))     oID.insertHtml('beforeend','<tr><td colspan="4"><span>载入中...</span></td></tr>');    this.itemListLoaded==false;    this.createItemList(postData,true);   }  },  setCheckedItems:function(){                     var cks=System.query('#itemListContainer input[type=checkbox]');   if(cks && cks.length){    var contain=false;    for(var i=0;i<cks.length;i++){     contain=dlAdm.items.containsKey(cks[i].value);     if(contain){      cks[i].checked=true;cks[i].disabled=true;     }else{      cks[i].checked=false;cks[i].disabled=false;     }    }   }cks=null;    },  loadItemData:function(itemID){   var me=this;   var oName=document.getElementById('tb_PartEdit_Name');   var oAddr=document.getElementById('tb_PartEdit_Addr');   var oDesc=document.getElementById('tb_PartEdit_Desc');   var oRelationType=document.getElementById("tb_PartEdit_RelationType");   if(!oName || !oAddr || !oDesc || !oRelationType) return false;   oName.vlaue='';oAddr.value='';oDesc.value='';   if(/^\d+$/.test(itemID)){    me.editItemID=itemID;    me.setEditMode();    Wade.ajax.AjaxLoading=false;    DraglayoutAdm.showLoadingMask("数据加载中..");    ajax.ajaxDirect(null,'getPageItemXmlData','Item_ID=' + itemID +'&randomt=' + Math.random(),'',false,function(r){     var xmlDoc=dlAdm.createXmlDocument(r.responseText);     if(xmlDoc){      var root=xmlDoc.rootElement || xmlDoc,d;      d=dh.DomQuery.selectValue('/pageitemxmldata/item/itemtitle',root);      oName.value=d;      d=dh.DomQuery.selectValue('/pageitemxmldata/item/itemaddr',root);      if(d && d!=='null')oAddr.value=d;      d=dh.DomQuery.selectValue('/pageitemxmldata/item/itemdesc',root);      if(d && d!=='null')oDesc.value=d;      d=dh.DomQuery.selectValue('/pageitemxmldata/item/relationtype',root);      if(d && d!=='null')oRelationType.value=d;      d=null;     }     oName=null;oAddr=null;oDesc=null;     Wade.page.endPageLoading();     DraglayoutAdm.hideLoadingMask();     Wade.ajax.AjaxLoading=true;    });   }else return false;  },  updateItemData:function(){   var me=this;   var oName=document.getElementById('tb_PartEdit_Name');   var oAddr=document.getElementById('tb_PartEdit_Addr');   var oDesc=document.getElementById('tb_PartEdit_Desc');   var oRelationType=document.getElementById("tb_PartEdit_RelationType");   if(!oName || !oAddr || !oDesc || !oRelationType) return false;   if(!titleStrReg.test(oName.value)){alert('部件名称输入不合法!');return false;}   if(oDesc.value!='' && !titleStrReg.test(oDesc.value)){alert('部件描述输入不合法!');return false;}   Wade.ajax.AjaxLoading=false;   DraglayoutAdm.showLoadingMask("数据处理中..");    var postbody=ajax.buildPostData({Item_ID:me.editItemID,Item_Name:oName.value,Item_Addr:oAddr.value,Item_Desc:oDesc.value,RelationType:oRelationType.value});      ajax.ajaxPost(null,'updatePageItem','randomt=' + Math.random(),'',false,postbody,true,function(r){       if(me.bUpTitle){        dlAdm.items.each(function(item){     if(/^\d+$/.test(item.index) && item.index==me.editItemID){          var span=System.fly(item.elm).child("span[name=itemtitle]");         if(span){span.update(oName.value);}span=null;     }     });    }else{     me.setChooseMode();     me.createItemList("",true);       }     oName.value='';oAddr.value='';oDesc.value='';    me.editItemID=null;          oName=null;oAddr=null;oDesc=null;    Wade.page.endPageLoading();    DraglayoutAdm.hideLoadingMask();    Wade.ajax.AjaxLoading=true;    if(me.bUpTitle && objDialog){objDialog.hide();}    me.bUpTitle=false;     System.CG();   });  } }})();DraglayoutAdm.PageTypeManager=(function(){ var dlAdm=DraglayoutAdm; var tbTypeNameIDPrefix='TB_PAGETYPE_NAME'; var tbTypeCodeIDPrefix='TB_PAGETYPE_CODE';   function getTbTypeNameObj(index){  var domId=index>0?tbTypeNameIDPrefix + '$' + (index-1):tbTypeNameIDPrefix;  var dom=document.getElementById(domId);  if(!dom){dom=document.getElementsByName(domId);if(dom && dom.length)dom=dom[0];else dom=null;}  return dom; };  function getTbTypeCodeObj(index){  var domId=index>0?tbTypeCodeIDPrefix + '$' + (index-1):tbTypeCodeIDPrefix;  var dom=document.getElementById(domId);  if(!dom){dom=document.getElementsByName(domId);if(dom && dom.length)dom=dom[0];else dom=null;}  return dom; }; return {  init:function(){   var me=this;            if(System.UserAgent.gecko){    var ls=dh.DomQuery.select('#' + dh.id(document.body) + ' div[class=l_height]');    if(ls && ls.length){     ls[0].style.height=dh.addUnits(dh.getViewHeight(true));    }ls=null;   }   },  addPageType:function(obj){      var tn=document.getElementById('PAGETYPE_NAME');      var tc=document.getElementById('PAGETYPE_CODE');      if(!tn){tn=document.getElementsByName('PAGETYPE_NAME');if(tn && tn.length)tn=tn[0];else tn=null;}      if(!tc){tc=document.getElementsByName('PAGETYPE_CODE');if(tc && tc.length)tc=tc[0];else tc=null;}      if(tn && tc){       if(!titleStrReg.test(tn.value)){alert('页面类型名称不合法！');return;}    if(!titleStrReg.test(tc.value)){alert('类型编号不合法！');return;}    var postbody=ajax.buildPostData({PAGETYPE_NAME:tn.value,PAGETYPE_CODE:tc.value});    ajax.ajaxPost(this,'addPageType','randomt=' + Math.random(),null,false,postbody,false,function(r){     Wade.page.endPageLoading();     window.location.reload();    });   }  },  deletePageType:function(e){   if(!confirm("确定要删除这个页面类型吗？")) return;   if(e && e.target && e.target.nodeType){    var typeid=dh.DomQuery.selectValue("@pagetypeid",e.target);    if(typeof(typeid)!="undefined" && typeid!==""){     ajax.ajaxDirect(null,"deletePageType","PageType_ID=" + typeid + "&randomt=" + Math.random(),'',false,function(){      Wade.page.endPageLoading();      window.location.reload();     });      }   }  },  updatePageType:function(e){   if(e && e.target && e.target.nodeType){    var typeid=dh.DomQuery.selectValue("@pagetypeid",e.target);    var index=dh.DomQuery.selectValue("@index",e.target);    if(/^\d+$/.test(typeid) && /^\d+$/.test(index)){     var tn=getTbTypeNameObj(index);     var tc=getTbTypeCodeObj(index);     if(!tn || !tc) return;     if(!titleStrReg.test(tn.value)){alert("页面类型名称不合法！");return;}     if(!titleStrReg.test(tc.value)){alert("类型编号不合法！");return;}     var fieldset=System.fly(e.target).findParentNode("fieldset",7);     if(fieldset){      fieldset=System.fly(fieldset).child("legend:first-child");      if(fieldset){fieldset.update(tn.value)}     }fieldset=null;          var postbody=ajax.buildPostData({PAGETYPE_NAME:tn.value,PAGETYPE_CODE:tc.value});     ajax.ajaxPost(this,"updatePageType","PageType_ID=" + typeid +"&randomt=" + Math.random(),null,false,postbody,false,function(r){      Wade.page.endPageLoading();           });      }   }    },      deletePage:function(e){   if(!confirm('确定要删除这个页面吗？')) return;   if(e && e.target && e.target.nodeType){    var pageid=dh.DomQuery.selectValue('@pageid',e.target);    if(/^\d+$/.test(pageid)){     ajax.ajaxDirect(null,'deletePage','Page_ID=' + pageid + '&randomt=' + Math.random(),'',false,function(){      Wade.page.endPageLoading();      var tr=System.fly(e.target).findParentNode("tr",7);      if(tr){System.fly(tr).remove();}tr=null;     });      }   }obj=null;    },  updatePageRelationType:function(sel){   if(!confirm('确定要更新该页面的关联类型吗？')){return false;};      ajaxDirect(this,'updatePageRelationType','&PAGE_ID=' + sel.getAttribute("pageid")+ '&PAGE_RELATIONTYPE='+sel.options[sel.selectedIndex].value,'content');  } };})();})();