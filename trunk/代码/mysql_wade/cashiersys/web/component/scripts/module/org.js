Wade.org=(function(){ var dom = Wade.dom; var ajax = Wade.ajax; var dialog = Wade.dialog; var util = Wade.util; var GrantConsts = {  GRANT_TYPE_PERSON : ["0", "个人"],  GRANT_TYPE_DEPART : ["1", "部门"],  GRANT_TYPE_AREA   : ["2", "业务区"],    GRANT_OPTION_STAFF   : ["1", "普通员工"],  GRANT_OPTION_MANAGER : ["2", "客户经理"] };  function checkSelf(value, direction) {  var grantFroms = dom.getElement("GRANT_FROMS");  var grantTos = dom.getElement("GRANT_TOS");  if (direction == "GRANT_FROMS") {   for (var i = grantTos.length; i > 0;) {    var v = grantTos.options[--i].value;    if (v && v.indexOf("&GRANT_TO=" + value) != -1) {     return true;    }   }  } else {   for (var i = grantFroms.length; i > 0;) {    var v = grantFroms.options[--i].value;    if (v == "&GRANT_TYPE=" + GrantConsts.GRANT_TYPE_PERSON[0] + "&GRANT_FROM=" + value) {     return true;    }   }  }    return false; }; return {    addTabsetByAreaTree : function () {   var tabset = new TabSet("tabset");   tabset.addTab("归属区域", dom.getElement("areaTree"));    tabset.addTab("授权区域", dom.getElement("grantTree"));   tabset.draw();   tabset.onTabSelect(this.tabEventHandlerByAreaTree);  },    tabEventHandlerByAreaTree : function(tabset) {   var tab = tabset.getActiveTab();   if (tab.caption == "授权区域") {    if (dom.getElement("GrantLoadTree") == null) {     ajax.ajaxDirect("component.org.AreaTree", "loadAreaTreeByGrant", "&clickflag=grant", "GrantPart");    }   }  },    addTabsetByDeptTree : function() {   var tabset = new TabSet("tabset");   tabset.addTab("归属部门", dom.getElement("deptTree"));    tabset.addTab("授权部门", dom.getElement("grantTree"));   tabset.draw();   tabset.onTabSelect(this.tabEventHandlerByDeptTree);  },    tabEventHandlerByDeptTree : function(tabset) {   var tab = tabset.getActiveTab();   if (tab.caption == "授权部门") {    if (dom.getElement("GrantLoadTree") == null) {     ajax.ajaxDirect("component.org.DeptTree", "loadDeptTreeByGrant", "&clickflag=grant", "GrantPart");    }   }  },    initStaffSelect : function() {   var relaflag = dom.getElementValue("relaflag");      var bcleanup = dom.getElement("bcleanup");   if (relaflag == "true") {    bcleanup.value = " 全部 ";   }  },    initManagerSelect : function() {   var bcleanup = dom.getElement("bcleanup");      if (!hasPriv("ORG_LIST_AREA") && !hasPriv("ORG_LIST_DEPT")) {    hidden(bcleanup, true);   }     },    selectStaffs : function() {   var staffids = "", staffnames = "";      var staffs = dom.getElements("staffs");   for (var i=0; i<staffs.length; i++) {    var staff = staffs[i];    if (staff.checked) {     var staffprop = staff.value.split(";");          staffids += (staffids == "" ? "" : ",") + staffprop[0];     staffnames += (staffnames == "" ? "" : ",") + staffprop[1];    }   }      dialog.setReturnValue(staffids, staffnames);  },    cleanupSelect : function() {   var relaflag = dom.getElementValue("relaflag");   var isblank = dom.getElementValue("isblank");   if (isblank == "true") {    dialog.setReturnValue("", "");   } else {    dialog.setReturnValue("", "全部员工");   }  },    addGrantObj : function(obj) {   var grantType = dom.getElementValue("GRANT_TYPE");   var grantTarget = obj.getAttribute("grant_target");   if (grantType == "") {    alert("请选择对象类型");    return false;   }   if (grantType == GrantConsts.GRANT_TYPE_PERSON[0]) {    dom.getElement('SELECT_STAFF_ID').setAttribute("grant_type", "GRANT_TYPE");    dom.getElement('SELECT_STAFF_ID').setAttribute("grant_target", grantTarget);    dom.getElement('POP_IMG_SELECT_STAFF_ID').click();   }   if (grantType == GrantConsts.GRANT_TYPE_DEPART[0]) {    dom.getElement('SELECT_DEPART_ID').setAttribute("grant_type", "GRANT_TYPE");    dom.getElement('SELECT_DEPART_ID').setAttribute("grant_target", grantTarget);    dom.getElement('POP_IMG_SELECT_DEPART_ID').click();   }   if (grantType == GrantConsts.GRANT_TYPE_AREA[0]) {    dom.getElement('SELECT_AREA_CODE').setAttribute("grant_type", "GRANT_TYPE");    dom.getElement('SELECT_AREA_CODE').setAttribute("grant_target", grantTarget);    dom.getElement('POP_IMG_SELECT_AREA_CODE').click();   }     },    delGrantObj : function(obj) {   var grantFroms = dom.getElement("GRANT_FROMS");   for (var i = grantFroms.length; i > 0;) {    var o = grantFroms.options[--i];    if (o.selected) {     grantFroms.remove(i);    }   }  },    addGrantStaff : function(obj) {   var grantObjType = dom.getElementValue("GRANT_OBJ_TYPE");   var grantTarget = obj.getAttribute("grant_target");   if (grantObjType == "") {    alert("请选择员工类型");    return false;   }   if (grantObjType == GrantConsts.GRANT_OPTION_STAFF[0]) {    dom.getElement('SELECT_STAFF_ID').setAttribute("grant_type", "GRANT_OBJ_TYPE");    dom.getElement('SELECT_STAFF_ID').setAttribute("grant_target", grantTarget);    dom.getElement('POP_IMG_SELECT_STAFF_ID').click();   }      if (grantObjType == GrantConsts.GRANT_OPTION_MANAGER[0]) {    dom.getElement('SELECT_MANAGER_ID').setAttribute("grant_type", "GRANT_OBJ_TYPE");    dom.getElement('SELECT_MANAGER_ID').setAttribute("grant_target", grantTarget);    dom.getElement('POP_IMG_SELECT_MANAGER_ID').click();   }  },    delGrantStaff : function(obj) {   var grantTos = dom.getElement("GRANT_TOS");   for (var i = grantTos.length; i > 0;) {    var o = grantTos.options[--i];    if (o.selected) {     grantTos.remove(i);    }   }  },    confirmGrant : function(obj) {   var grantFroms = dom.getElement("GRANT_FROMS");   var grantTos = dom.getElement("GRANT_TOS");   if (grantFroms.options.length == 0) {    alert("授权对象不能为空！");    dom.focus(grantFroms);    return false;   }   if (grantTos.options.length == 0) {    alert("授权员工不能为空！");    dom.focus(grantTos);    return false;   }      dom.selectedAll("GRANT_FROMS");   dom.selectedAll("GRANT_TOS");   return confirmForm(obj);  },    afterSelectStaff : function(obj) {   var staff_id = dom.getElement("SELECT_STAFF_ID");   var staff_name = dom.getElement("POP_SELECT_STAFF_ID");   var grantType = dom.getElementValue(staff_id.getAttribute("grant_type"));   var grantTarget = staff_id.getAttribute("grant_target");   if (!staff_id) {    if (staff_id.value == "" && staff_name.value != "") {     alert("添加失败，不能选择全部员工");    }    return false;   }   if (checkSelf(staff_id.value, grantTarget)) {    alert("添加失败，不能将员工授权给自己");    return false;   }   var value = "&" + staff_id.getAttribute("grant_type") + "=" + grantType + "&" + grantTarget.substring(0, grantTarget.length - 1) + "=" + staff_id.value;   var text = "对象类型:" + GrantConsts.GRANT_TYPE_PERSON[1] + "       对象名称:" + staff_name.value;      var grants = dom.getElement(grantTarget);   if (!containKey(grants.options, value)) {    grants.add(new Option(text, value));   }      staff_id.value = "";   staff_name.value = "";   staff_id.setAttribute("grant_type", "");   staff_id.setAttribute("grant_target", "");  },    afterSelectDepart : function(obj) {   var depart_id = dom.getElement("SELECT_DEPART_ID");   var depart_name = dom.getElement("POP_SELECT_DEPART_ID");   var grantType = dom.getElementValue(depart_id.getAttribute("grant_type"));   var grantTarget = depart_id.getAttribute("grant_target");      if (!depart_id) {    if (depart_id.value == "" && depart_name.value != "") {     alert("添加失败，不能选择全部部门");    }    return false;   }   var value = "&" + depart_id.getAttribute("grant_type") + "=" + grantType + "&" + grantTarget.substring(0, grantTarget.length - 1) + "=" + depart_id.value;   var text = "对象类型:" + GrantConsts.GRANT_TYPE_DEPART[1] + "       对象名称:" + depart_name.value;      var grants = dom.getElement(grantTarget);   if (!containKey(grants.options, value)) {    grants.add(new Option(text, value));   }      depart_id.value = "";   depart_name.value = "";   depart_id.setAttribute("grant_type", "");   depart_id.setAttribute("grant_target", "");  },    afterSelectManager : function(obj) {   var manager_id = dom.getElement("SELECT_MANAGER_ID");   var manager_name = dom.getElement("POP_SELECT_MANAGER_ID");   var grantType = dom.getElementValue(manager_id.getAttribute("grant_type"));   var grantTarget = manager_id.getAttribute("grant_target");      if (!manager_id) {    if (manager_id.value == "" && manager_name.value != "") {     alert("添加失败，不能选择全部员工");    }    return false;   }   if (checkSelf(manager_id.value, grantTarget)) {    alert("添加失败，不能将员工授权给自己");    return false;   }   var value = "&" + manager_id.getAttribute("grant_type") + "=" + grantType + "&" + grantTarget.substring(0, grantTarget.length - 1) + "=" + manager_id.value;   var text = "员工类型:" + GrantConsts.GRANT_OPTION_MANAGER[1] + "    员工名称:" + manager_name.value;      var grants = dom.getElement(grantTarget);   if (!containKey(grants.options, value)) {    grants.add(new Option(text, value));   }      manager_id.value = "";   manager_name.value = "";   manager_id.setAttribute("grant_type", "");   manager_id.setAttribute("grant_target", "");  },    afterSelectArea : function(obj) {   var area_code = dom.getElement("SELECT_AREA_CODE");   var area_name = dom.getElement("POP_SELECT_AREA_CODE");   var grantType = dom.getElementValue(area_code.getAttribute("grant_type"));   var grantTarget = area_code.getAttribute("grant_target");      if (!area_code) {    if (area_code.value == "" && area_name.value != "") {     alert("添加失败，不能选择全部区域");    }    return false;   }   var value = "&" + area_code.getAttribute("grant_type") + "=" + grantType + "&" + grantTarget.substring(0, grantTarget.length - 1) + "=" + area_code.value;   var text = "对象类型:" + GrantConsts.GRANT_TYPE_AREA[1] + "    对象名称:" + area_name.value;      var grants = dom.getElement(grantTarget);   if (!containKey(grants.options, value)) {    grants.add(new Option(text, value));   }      area_code.value = "";   area_name.value = "";   area_code.setAttribute("grant_type", "");   area_code.setAttribute("grant_target", "");  } }})();